name: X Autopost

on:
  schedule:
    # JST 07:00 / 12:00 / 19:00  ->  UTC 22:00 / 03:00 / 10:00
    - cron: '0 22 * * *'
    - cron: '0 3 * * *'
    - cron: '0 10 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: '1: DRY_RUN (default). 0: post if Secrets are set.'
        required: false
        default: '1'
      force_post:
        description: '1: fail if Secrets are missing (misconfig detection).'
        required: false
        default: '0'

concurrency:
  group: x-autopost
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  autopost:
    runs-on: ubuntu-latest
    env:
      DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && inputs.dry_run || '1' }}
      FORCE_POST: ${{ github.event_name == 'workflow_dispatch' && inputs.force_post || '0' }}
      X_API_BASE_URL: https://api.x.com
      X_API_KEY: ${{ secrets.X_API_KEY }}
      X_API_KEY_SECRET: ${{ secrets.X_API_KEY_SECRET }}
      X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
      X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r tools/requirements.txt

      - name: Install Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: '0.149.0'
          extended: true

      - name: Run autopost
        run: python -m tools.autopost

      - name: Commit updated state (only when changed)
        if: github.ref == 'refs/heads/main'
        run: |
          if git diff --quiet -- .autopost/state.json; then
            echo "No state changes."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git pull --rebase origin main
          git add .autopost/state.json

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "chore(autopost): update state [skip ci]"
          git push origin HEAD:main
